<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 예보</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/static/global/global.css}" />
    <link rel="stylesheet" th:href="@{/static/global/style.css}" />
</head>
<body>
<div class="weather-container" role="main">
    <!-- 날씨 헤더 -->
    <section class="weather-header" aria-label="현재 날씨 정보">
        <p class="datetime">
            <span class="date" th:text="${weather.date}"></span>
            <span class="time" th:text="${weather.time}"></span>
            <span class="timeofday" th:text="${timeOfDay}"></span>
        </p>
        <div class="location-row">
            <h1 id="locationTitle" th:text="${weather.location}"></h1>
            <button class="location-btn" onclick="openLocationPopup()" aria-label="위치 변경">변경</button>
        </div>
        <div class="weather-main">
            <div class="current-temp">
                <span class="weather-icon" th:classappend="${weather.hourlyForecast[0].icon}" aria-hidden="true"></span>
                <span th:text="${weather.currentTemperature}" class="temp-value" aria-label="현재 온도"></span>
                <div class="temp-range" th:text="${weather.highLowTemperature}" aria-label="최고/최저 온도"></div>
            </div>
            <div class="weather-info">
                <div class="weather-condition" th:text="${weather.weatherCondition}"></div>
                <div class="humidity" th:text="'습도 ' + ${weather.hourlyForecast[0].humidity}"></div>
                <div class="pm-value" th:text="'미세먼지 ' + ${weather.airQuality.value}"></div>
            </div>
        </div>
    </section>

    <!-- 날씨 상세 정보 -->
    <section class="weather-details" aria-label="날씨 상세 정보">
        <div class="air-quality">
            <h3 th:text="${weather.airQuality.title}"></h3>
            <span class="icon" th:classappend="${weather.airQuality.icon}" aria-hidden="true"></span>
            <p class="status" th:text="${weather.airQuality.status}"></p>
            <p th:text="${weather.airQuality.value} + ' ' + ${weather.airQuality.measurement}"></p>
        </div>
        <div class="uv-index">
            <h3 th:text="${weather.uvIndex.title}"></h3>
            <span class="icon" th:classappend="${weather.uvIndex.icon}" aria-hidden="true"></span>
            <p class="status" th:text="${weather.uvIndex.status}"></p>
            <p th:text="${weather.uvIndex.value} + ' ' + ${weather.uvIndex.measurement}"></p>
        </div>
    </section>

    <!-- 시간대별 날씨 예보 -->
    <section class="forecast-section" aria-label="시간대별 날씨 예보">
        <h3>시간대별 날씨</h3>
        <div class="forecast-row">
            <div th:each="forecast : ${weather.hourlyForecast}" class="forecast-item">
                <span class="time" th:text="${forecast.time}"></span>
                <span class="icon" th:classappend="${forecast.icon}" aria-hidden="true"></span>
                <span class="temp" th:text="${forecast.temperature}"></span>
                <span class="humid" th:text="${forecast.humidity}"></span>
            </div>
        </div>
    </section>

    <!-- 미세먼지 예보 -->
    <section class="dust-forecast-section" aria-label="미세먼지 예보">
        <h3>미세먼지 예보</h3>
        <div th:if="${dustForecast != null}">
            <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn prev" onclick="moveSlide(-1)" aria-label="이전 슬라이드">❮</button>
            <div class="dust-slider" id="dustSlider">
                <div th:each="forecast, iter : ${dustForecast}" class="dust-forecast-item">
                    <h4 th:text="${forecast.date} + ' (' + ${forecast.type} + ')'"></h4>
                    <p th:text="'시간: ' + ${forecast.dataTime}"></p>
                    <p class="overall-text" th:text="${forecast.overall}" th:unless="${forecast.overall == 'N/A'}"></p>
                    <p class="cause-text" th:text="${forecast.cause}" th:unless="${forecast.cause == 'N/A'}"></p>
                    <div class="grade-section">
                        <table class="grade-table">
                            <tr>
                                <th th:if="${#lists.size(categorizedForecast[iter.index].first) > 0 and categorizedForecast[iter.index].first[0] != '없음'}"
                                    class="grade-title good">좋음</th>
                                <th th:if="${#lists.size(categorizedForecast[iter.index].second) > 0 and categorizedForecast[iter.index].second[0] != '없음'}"
                                    class="grade-title moderate">보통</th>
                                <th th:if="${#lists.size(categorizedForecast[iter.index].third) > 0 and categorizedForecast[iter.index].third[0] != '없음'}"
                                    class="grade-title bad">나쁨</th>
                            </tr>
                            <tr th:each="i : ${#numbers.sequence(0,
                                #lists.size(categorizedForecast[iter.index].first) > #lists.size(categorizedForecast[iter.index].second) ?
                                (#lists.size(categorizedForecast[iter.index].first) > #lists.size(categorizedForecast[iter.index].third) ?
                                #lists.size(categorizedForecast[iter.index].first) - 1 : #lists.size(categorizedForecast[iter.index].third) - 1) :
                                (#lists.size(categorizedForecast[iter.index].second) > #lists.size(categorizedForecast[iter.index].third) ?
                                #lists.size(categorizedForecast[iter.index].second) - 1 : #lists.size(categorizedForecast[iter.index].third) - 1))}">
                                <td th:if="${#lists.size(categorizedForecast[iter.index].first) > i and categorizedForecast[iter.index].first[i] != '없음'}"
                                    th:text="${categorizedForecast[iter.index].first[i]}"
                                    class="grade-cell good"></td>
                                <td th:if="${#lists.size(categorizedForecast[iter.index].second) > i and categorizedForecast[iter.index].second[i] != '없음'}"
                                    th:text="${categorizedForecast[iter.index].second[i]}"
                                    class="grade-cell moderate"></td>
                                <td th:if="${#lists.size(categorizedForecast[iter.index].third) > i and categorizedForecast[iter.index].third[i] != '없음'}"
                                    th:text="${categorizedForecast[iter.index].third[i]}"
                                    class="grade-cell bad"></td>
                            </tr>
                        </table>
                    </div>
                    <div th:if="${forecast.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                        <h5 class="image-title">예보 이미지</h5>
                        <div class="forecast-images">
                            <img th:each="url : ${forecast.imageUrls}" th:src="${url}" alt="예보 이미지" onclick="openPopup(this.src)" />
                        </div>
                    </div>
                    <div th:unless="${forecast.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                        <h5 class="image-title">이미지 없음</h5>
                    </div>
                </div>
            </div>
            <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn next" onclick="moveSlide(1)" aria-label="다음 슬라이드">❯</button>
        </div>
        <div th:unless="${dustForecast != null}">
            <p>미세먼지 예보 데이터를 불러올 수 없습니다. (날짜 형식이 잘못되었거나 API 요청이 실패했습니다.)</p>
        </div>
    </section>

    <!-- 실시간 미세먼지 -->
    <section class="real-time-dust-section" aria-label="실시간 미세먼지">
        <h3>실시간 미세먼지</h3>
        <div th:if="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
            <table class="real-time-dust-table">
                <thead>
                <tr>
                    <th>시도</th>
                    <th>측정소</th>
                    <th>측정 시간</th>
                    <th>미세먼지(PM10)</th>
                    <th>미세먼지 등급</th>
                    <th>초미세먼지(PM2.5)</th>
                    <th>초미세먼지 등급</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="dust : ${realTimeDust}">
                    <td th:text="${dust.sidoName}"></td>
                    <td th:text="${dust.stationName}"></td>
                    <td th:text="${dust.dataTime}"></td> <!-- 문제 발생 지점 수정 -->
                    <td>
                        <span th:if="${dust.pm10Value != 'N/A'}" th:text="${dust.pm10Value} + ' μg/m³'"></span>
                        <span th:unless="${dust.pm10Value != 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <td class="grade-cell" th:switch="${dust.pm10Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                    <td>
                        <span th:if="${dust.pm25Value != 'N/A'}" th:text="${dust.pm25Value} + ' μg/m³'"></span>
                        <span th:unless="${dust.pm25Value != 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <td class="grade-cell" th:switch="${dust.pm25Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
            <p th:text="${errorMessage ?: '실시간 미세먼지 데이터를 불러올 수 없습니다.'}" style="color: red;"></p>
        </div>
    </section>

    <!-- 자외선 지수 예보 -->
    <section class="uv-index-forecast-section" aria-label="자외선 지수 예보">
        <h3>자외선 지수 예보</h3>
        <div th:if="${uvIndexData != null and not #lists.isEmpty(uvIndexData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${uvHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="uv : ${uvIndexData}">
                    <td th:text="${uv.date}"></td>
                    <td th:each="hour : ${uvHoursSequence}">
                    <span th:switch="${uv.values['h' + hour]}">
                        <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                        <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                        <span th:case="*" th:text="${uv.values['h' + hour]}"></span>
                    </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${uvIndexData != null and not #lists.isEmpty(uvIndexData)}">
            <p style="color: red;">자외선 지수 데이터: [[${uvIndexData}]]</p>
        </div>
    </section>

    <!-- 여름철 체감온도 예보 -->
    <section class="senta-index-forecast-section" aria-label="여름철 체감온도 예보">
        <h3>여름철 체감온도 예보 (5월~9월)</h3>
        <div th:if="${senTaIndexData != null and not #lists.isEmpty(senTaIndexData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${sentaHoursSequence}" th:text="'+' + ${hour - 1} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="senta : ${senTaIndexData}">
                    <td th:text="${senta.date}"></td>
                    <td th:each="hour : ${sentaHoursSequence}">
                            <span th:switch="${senta.values['h' + hour]}">
                                <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="*" th:text="${senta.values['h' + hour]}"></span>
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${senTaIndexData != null and not #lists.isEmpty(senTaIndexData)}">
            <p style="color: red;">체감온도 데이터를 불러올 수 없습니다. (5월~9월에만 제공됩니다.)</p>
        </div>
    </section>

    <!-- 대기정체지수 예보 -->
    <section class="air-stagnation-index-forecast-section" aria-label="대기정체지수 예보">
        <h3>대기정체지수 예보</h3>
        <div th:if="${airStagnationIndexData != null and not #lists.isEmpty(airStagnationIndexData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${asiHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="asi : ${airStagnationIndexData}">
                    <td th:text="${asi.date}"></td>
                    <td th:each="hour : ${asiHoursSequence}">
                            <span th:switch="${asi.values['h' + hour]}">
                                <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="*" th:text="${asi.values['h' + hour]}"></span>
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${airStagnationIndexData != null and not #lists.isEmpty(airStagnationIndexData)}">
            <p style="color: red;">대기정체지수 데이터를 불러올 수 없습니다.</p>
        </div>
    </section>

    <!-- 강수량 예보 -->
    <section class="precipitation-forecast-section" aria-label="강수량 예보">
        <h3>강수량 예보</h3>
        <div th:if="${precipitationData != null and not #lists.isEmpty(precipitationData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${precipHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="precip : ${precipitationData}">
                    <td th:text="${precip.date}"></td>
                    <td th:each="hour : ${precipHoursSequence}">
                            <span th:switch="${precip.values['h' + hour]}">
                                <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                                <span th:case="*" th:text="${precip.values['h' + hour]}"></span>
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${precipitationData != null and not #lists.isEmpty(precipitationData)}">
            <p style="color: red;">강수량 데이터를 불러올 수 없습니다.</p>
        </div>
    </section>
</div>

<!-- 이미지 팝업 -->
<div id="imagePopup" class="popup" role="dialog" aria-label="이미지 확대 팝업">
    <div class="popup-content">
        <button class="close-btn" onclick="closePopup()" aria-label="팝업 닫기">X</button>
        <img id="popupImage" src="" alt="확대된 이미지">
    </div>
</div>

<!-- 위치 선택 팝업 -->
<div id="locationPopup" class="popup" role="dialog" aria-label="위치 선택 팝업">
    <div id="locationPopupContent">
        <button class="close-btn" onclick="closeLocationPopup()" aria-label="팝업 닫기">X</button>
        <div class="select-group">
            <label for="sido">시/도:</label>
            <select id="sido" onchange="updateSggs()" aria-label="시/도 선택">
                <option value="">선택하세요</option>
                <th:block th:each="sido : ${sidos}">
                    <option th:value="${sido}" th:text="${sido}" th:selected="${sido == selectedSido}"></option>
                </th:block>
            </select>
        </div>
        <div class="select-group">
            <label for="sgg">시/군/구:</label>
            <select id="sgg" onchange="updateUmds()" aria-label="시/군/구 선택">
                <option value="">먼저 시/도를 선택하세요</option>
                <th:block th:each="sgg : ${sggs}">
                    <option th:value="${sgg}" th:text="${sgg}" th:selected="${sgg == selectedSgg}"></option>
                </th:block>
            </select>
        </div>
        <div class="select-group">
            <label for="umd">읍/면/동:</label>
            <select id="umd" aria-label="읍/면/동 선택">
                <option value="">먼저 시/군/구를 선택하세요</option>
                <th:block th:each="umd : ${umds}">
                    <option th:value="${umd}" th:text="${umd}" th:selected="${umd == selectedUmd}"></option>
                </th:block>
            </select>
        </div>
        <button id="confirmBtn" onclick="confirmSelection()" aria-label="위치 확인">확인</button>
    </div>
</div>

<script>
    let currentSlide = 0;

    function updateSlidePosition() {
        const slider = document.getElementById('dustSlider');
        if (!slider) return;
        const items = slider.querySelectorAll('.dust-forecast-item');
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
        document.querySelector('.slider-btn.prev').disabled = currentSlide === 0;
        document.querySelector('.slider-btn.next').disabled = currentSlide === items.length - 1;
    }

    function moveSlide(direction) {
        const items = document.querySelectorAll('.dust-forecast-item');
        currentSlide = Math.max(0, Math.min(currentSlide + direction, items.length - 1));
        updateSlidePosition();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const overallTexts = document.querySelectorAll('.overall-text');
        overallTexts.forEach(element => element.textContent = removeParentheses(element.textContent));
        const causeTexts = document.querySelectorAll('.cause-text');
        causeTexts.forEach(element => element.textContent = removeParentheses(element.textContent));

        const items = document.querySelectorAll('.dust-forecast-item');
        if (items.length <= 1) {
            document.querySelectorAll('.slider-btn').forEach(btn => btn.style.display = 'none');
        } else {
            updateSlidePosition();
        }

        const locationTitle = document.getElementById('locationTitle');
        if (!locationTitle.textContent.trim()) locationTitle.textContent = '청진동 (종로구)';

        const sidoSelect = document.getElementById('sido');
        const selectedSido = '[[${selectedSido}]]';
        if (selectedSido && selectedSido !== '') {
            sidoSelect.value = selectedSido;
            updateSggs().then(() => {
                const sggSelect = document.getElementById('sgg');
                const selectedSgg = '[[${selectedSgg}]]';
                if (selectedSgg && selectedSgg !== '') {
                    sggSelect.value = selectedSgg;
                    updateUmds().then(() => {
                        const umdSelect = document.getElementById('umd');
                        const selectedUmd = '[[${selectedUmd}]]';
                        if (selectedUmd && selectedUmd !== '') umdSelect.value = selectedUmd;
                    });
                }
            });
        }
    });

    function removeParentheses(text) {
        return text.replace(/\([^()]*\)/g, '').replace(/\[.*?\]/g, '').replace(/\./g, '').trim();
    }

    function openPopup(imageUrl) {
        const popup = document.getElementById('imagePopup');
        document.getElementById('popupImage').src = imageUrl;
        popup.style.display = 'flex';
    }

    function closePopup() {
        document.getElementById('imagePopup').style.display = 'none';
    }

    function openLocationPopup() {
        document.getElementById('locationPopup').style.display = 'flex';
    }

    function closeLocationPopup() {
        document.getElementById('locationPopup').style.display = 'none';
    }

    async function updateSggs() {
        const sido = document.getElementById('sido').value;
        const sggSelect = document.getElementById('sgg');
        const umdSelect = document.getElementById('umd');

        sggSelect.innerHTML = '<option value="">선택하세요</option>';
        umdSelect.innerHTML = '<option value="">먼저 시/군/구를 선택하세요</option>';

        if (!sido) return;

        try {
            const response = await fetch(`/api/regions/sggs?sido=${encodeURIComponent(sido)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const sggs = await response.json();
            if (sggs.length === 0) {
                sggSelect.innerHTML = '<option value="">시/군/구 데이터 없음</option>';
            } else {
                sggs.forEach(sgg => {
                    const option = document.createElement('option');
                    option.value = sgg;
                    option.textContent = sgg;
                    sggSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('시군구 데이터 가져오기 실패:', error);
            sggSelect.innerHTML = '<option value="">시/군/구 데이터를 불러올 수 없습니다</option>';
        }
    }

    async function updateUmds() {
        const sido = document.getElementById('sido').value;
        const sgg = document.getElementById('sgg').value;
        const umdSelect = document.getElementById('umd');

        umdSelect.innerHTML = '<option value="">선택하세요</option>';

        if (!sido || !sgg) return;

        try {
            const response = await fetch(`/api/regions/umds?sido=${encodeURIComponent(sido)}&sgg=${encodeURIComponent(sgg)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const umds = await response.json();
            if (umds.length === 0) {
                umdSelect.innerHTML = '<option value="">읍/면/동 데이터 없음</option>';
            } else {
                umds.forEach(umd => {
                    const option = document.createElement('option');
                    option.value = umd;
                    option.textContent = umd;
                    umdSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('읍면동 데이터 가져오기 실패:', error);
            umdSelect.innerHTML = '<option value="">읍/면/동 데이터를 불러올 수 없습니다</option>';
        }
    }

    function confirmSelection() {
        const sido = document.getElementById('sido').value;
        const sgg = document.getElementById('sgg').value;
        const umd = document.getElementById('umd').value;

        if (!sido || !sgg || !umd) {
            alert('모든 항목을 선택해 주세요.');
            return;
        }

        document.getElementById('locationTitle').textContent = `${umd} (${sgg})`;
        closeLocationPopup();

        fetch(`/weather?location=${encodeURIComponent(`${sido} ${sgg} ${umd}`)}`)
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('날씨 데이터 업데이트하는 데 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('날씨 데이터 업데이트 실패:', error);
                alert('날씨 데이터를 업데이트하는 데 실패했습니다.');
            });
    }
</script>
</body>
</html>