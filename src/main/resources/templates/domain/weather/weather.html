<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 예보</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/static/global/style.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="weather-container" role="main">
    <!-- 날씨 헤더 -->
    <section class="weather-header" aria-label="현재 날씨 정보">
        <p class="datetime">
            <span class="date" th:text="${weather?.date ?: '날짜 없음'}"></span>
            <span class="time" th:text="${weather?.time ?: '시간 없음'}"></span>
            <span class="timeofday" th:text="${timeOfDay ?: '정보 없음'}"></span>
        </p>
        <div class="location-row">
            <h1 id="locationTitle" th:text="${weather?.location ?: '위치 없음'}"></h1>
            <button class="location-btn" onclick="openLocationPopup()" aria-label="위치 변경">변경</button>
        </div>
        <div class="weather-main">
            <div class="current-temp">
                <span class="weather-icon" th:classappend="${weather?.hourlyForecast != null and not #lists.isEmpty(weather.hourlyForecast) ? weather.hourlyForecast[0].icon : ''}" aria-hidden="true"></span>
                <span th:text="${weather?.currentTemperature ?: '온도 없음'}" class="temp-value" aria-label="현재 온도"></span>
                <div class="temp-range" th:text="${weather?.highLowTemperature ?: '최고/최저 없음'}" aria-label="최고/최저 온도"></div>
            </div>
            <div class="weather-info">
                <div class="weather-condition" th:text="${weather?.weatherCondition ?: '상태 없음'}"></div>
                <div class="humidity" th:text="${weather?.hourlyForecast != null and not #lists.isEmpty(weather.hourlyForecast) ? '습도 ' + weather.hourlyForecast[0].humidity : '습도 없음'}"></div>
                <div class="pm-value" th:text="${weather?.airQuality != null ? '미세먼지 ' + weather.airQuality.value + ' ' + weather.airQuality.measurement : '미세먼지 없음'}"></div>
                <div class="pm25-value" th:text="'날씨정보상세보기'"></div>
            </div>
        </div>
    </section>

    <!-- 날씨 상세 정보 -->
    <section class="weather-details" aria-label="날씨 상세 정보">
        <div class="dust-buttons-container">
            <button class="dust-forecast-btn" onclick="alert('안녕 디지몬')" aria-label="추가기능">추가기능</button>
            <button class="dust-forecast-btn" onclick="openDustForecastPopup()" aria-label="미세먼지 예보 보기">미세먼지 예보 보기</button>
            <button class="real-time-dust-btn" onclick="openRealTimeDustPopup()" aria-label="실시간 미세먼지 보기">실시간 미세먼지 보기</button>
        </div>
        <div class="air-quality-container">
            <div class="air-quality">
                <h3 th:text="${weather?.airQuality?.title ?: '공기질 없음'}"></h3>
                <span class="icon" th:classappend="${weather?.airQuality?.icon ?: ''}" aria-hidden="true"></span>
                <p class="status" th:text="${weather?.airQuality?.status ?: '상태 없음'}"></p>
                <p th:text="${weather?.airQuality != null ? weather.airQuality.value + ' ' + weather.airQuality.measurement : '값 없음'}"></p>
            </div>
            <div class="air-quality">
                <h3 th:text="${weather?.airQuality?.title2 ?: '공기질 없음'}"></h3>
                <span class="icon" th:classappend="${weather?.airQuality?.icon ?: ''}" aria-hidden="true"></span>
                <p class="status" th:text="${weather?.airQuality?.status2 ?: '상태 없음'}"></p>
                <p th:text="${weather?.airQuality != null ? weather.airQuality.value2 + ' ' + weather.airQuality.measurement2 : '값 없음'}"></p>
            </div>
        </div>
    </section>

    <!-- 시간대별 날씨 예보 -->
    <section class="forecast-section" aria-label="시간대별 날씨 예보">
        <h3>시간대별 날씨</h3>
        <div class="forecast-row">
            <div th:each="forecast : ${weather?.hourlyForecast ?: {}}" class="forecast-item">
                <span class="time" th:text="${forecast?.time ?: '시간 없음'}"></span><br/><br/>
                <span class="temp" th:text="${forecast?.temperature ?: '온도 없음'}"></span><br/><br/>
                <span class="icon" th:classappend="${forecast?.icon ?: ''}" aria-hidden="true"></span><br/><br/>
                <span class="humid" th:text="${forecast?.humidity ?: '습도 없음'}"></span>
            </div>
        </div>
    </section>

    <!-- 여름철 체감온도 예보 -->
    <section class="senta-index-forecast-section" aria-label="여름철 체감온도 예보">
        <h3>여름철 체감온도 예보 (5월~9월)</h3>
        <div th:if="${senTaIndexData != null and not #lists.isEmpty(senTaIndexData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${sentaHoursSequence}" th:text="'+' + ${hour - 1} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="senta : ${senTaIndexData}">
                    <td th:text="${senta?.date ?: '날짜 없음'}"></td>
                    <td th:each="hour : ${sentaHoursSequence}">
                        <span th:switch="${senta?.values != null ? senta.values['h' + hour] : null}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${senta.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="chart-container" style="display: none;">
                <canvas id="temperatureChart"></canvas>
            </div>
            <button class="chart-btn" onclick="toggleChart(this)" aria-label="차트 보기"><span>대시보드</span></button>
        </div>
        <div th:unless="${senTaIndexData != null and not #lists.isEmpty(senTaIndexData)}">
            <p style="color: red;">체감온도 데이터를 불러올 수 없습니다. (5월~9월에만 제공됩니다.)</p>
        </div>
    </section>

    <!-- 대기정체지수 예보 -->
    <section class="air-stagnation-index-forecast-section" aria-label="대기정체지수 예보">
        <h3>대기정체지수 예보</h3>
        <div th:if="${airStagnationIndexData != null and not #lists.isEmpty(airStagnationIndexData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${asiHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="asi : ${airStagnationIndexData}">
                    <td th:text="${asi?.date ?: '날짜 없음'}"></td>
                    <td th:each="hour : ${asiHoursSequence}">
                        <span th:switch="${asi?.values != null ? asi.values['h' + hour] : null}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${asi.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${airStagnationIndexData != null and not #lists.isEmpty(airStagnationIndexData)}">
            <p style="color: red;">대기정체지수 데이터를 불러올 수 없습니다.</p>
        </div>
    </section>

    <!-- 강수량 예보 -->
    <section class="precipitation-forecast-section" aria-label="강수량 예보">
        <h3>강수량 예보</h3>
        <div th:if="${precipitationData != null and not #lists.isEmpty(precipitationData)}">
            <table class="forecast-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${precipHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="precip : ${precipitationData}">
                    <td th:text="${precip?.date ?: '날짜 없음'}"></td>
                    <td th:each="hour : ${precipHoursSequence}">
                        <span th:switch="${precip?.values != null ? precip.values['h' + hour] : null}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${precip.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:unless="${precipitationData != null and not #lists.isEmpty(precipitationData)}">
            <p style="color: red;">강수량 데이터를 불러올 수 없습니다.</p>
        </div>
    </section>
</div>

<!-- 이미지 팝업 -->
<div id="imagePopup" class="popup" role="dialog" aria-label="이미지 확대 팝업">
    <div class="popup-content">
        <button class="close-btn" onclick="closePopup()" aria-label="팝업 닫기">X</button>
        <img id="popupImage" src="" alt="확대된 이미지">
    </div>
</div>

<!-- 위치 선택 팝업 -->
<div id="locationPopup" class="popup" role="dialog" aria-label="위치 선택 팝업">
    <div id="locationPopupContent">
        <button class="close-btn2" onclick="closeLocationPopup()" aria-label="팝업 닫기">X</button>
        <div class="select-group">
            <label for="sido">시/도:</label>
            <select id="sido" onchange="updateSggs()" aria-label="시/도 선택">
                <option value="">선택하세요</option>
                <th:block th:each="sido : ${sidos}">
                    <option th:value="${sido}" th:text="${sido}" th:selected="${sido == selectedSido}"></option>
                </th:block>
            </select>
        </div>
        <div class="select-group">
            <label for="sgg">시/군/구:</label>
            <select id="sgg" onchange="updateUmds()" aria-label="시/군/구 선택">
                <option value="">먼저 시/도를 선택하세요</option>
                <th:block th:each="sgg : ${sggs}">
                    <option th:value="${sgg}" th:text="${sgg}" th:selected="${sgg == selectedSgg}"></option>
                </th:block>
            </select>
        </div>
        <div class="select-group">
            <label for="umd">읍/면/동:</label>
            <select id="umd" aria-label="읍/면/동 선택">
                <option value="">먼저 시/군/구를 선택하세요</option>
                <th:block th:each="umd : ${umds}">
                    <option th:value="${umd}" th:text="${umd}" th:selected="${umd == selectedUmd}"></option>
                </th:block>
            </select>
        </div>
        <button id="confirmBtn" onclick="confirmSelection()" aria-label="위치 확인">확인</button>
    </div>
</div>

<!-- 미세먼지 예보 팝업 -->
<div id="dustForecastPopup" class="popup" role="dialog" aria-label="미세먼지 예보 팝업">
    <div class="popup-content">
        <button class="close-btn" onclick="closeDustForecastPopup()" aria-label="팝업 닫기">X</button>
        <section class="dust-forecast-section" aria-label="미세먼지 예보">
            <h3>미세먼지 예보</h3>
            <div th:if="${dustForecast != null}">
                <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn prev" onclick="moveSlide(-1)" aria-label="이전 슬라이드">❮</button>
                <div class="dust-slider" id="dustSlider">
                    <div th:each="forecast, iter : ${dustForecast}" class="dust-forecast-item">
                        <h4 th:text="${forecast?.date + ' (' + forecast?.type + ')' ?: '정보 없음'}"></h4>
                        <p th:text="'시간: ' + ${forecast?.dataTime ?: '없음'}"></p>
                        <p class="overall-text" th:text="${forecast?.overall ?: 'N/A'}" th:unless="${forecast?.overall == 'N/A'}"></p>
                        <p class="cause-text" th:text="${forecast?.cause ?: 'N/A'}" th:unless="${forecast?.cause == 'N/A'}"></p>
                        <div class="grade-section">
                            <table AJAXclass="grade-table">
                                <tr>
                                    <th th:if="${#lists.size(categorizedForecast[iter.index].first) > 0 and categorizedForecast[iter.index].first[0] != '없음'}"
                                        class="grade-title good">좋음</th>
                                    <th th:if="${#lists.size(categorizedForecast[iter.index].second) > 0 and categorizedForecast[iter.index].second[0] != '없음'}"
                                        class="grade-title moderate">보통</th>
                                    <th th:if="${#lists.size(categorizedForecast[iter.index].third) > 0 and categorizedForecast[iter.index].third[0] != '없음'}"
                                        class="grade-title bad">나쁨</th>
                                </tr>
                                <tr th:each="i : ${#numbers.sequence(0,
                                    #lists.size(categorizedForecast[iter.index].first) > #lists.size(categorizedForecast[iter.index].second) ?
                                    (#lists.size(categorizedForecast[iter.index].first) > #lists.size(categorizedForecast[iter.index].third) ?
                                    #lists.size(categorizedForecast[iter.index].first) - 1 : #lists.size(categorizedForecast[iter.index].third) - 1) :
                                    (#lists.size(categorizedForecast[iter.index].second) > #lists.size(categorizedForecast[iter.index].third) ?
                                    #lists.size(categorizedForecast[iter.index].second) - 1 : #lists.size(categorizedForecast[iter.index].third) - 1))}">
                                    <td th:if="${#lists.size(categorizedForecast[iter.index].first) > i and categorizedForecast[iter.index].first[i] != '없음'}"
                                        th:text="${categorizedForecast[iter.index].first[i]}"
                                        class="grade-cell good"></td>
                                    <td th:if="${#lists.size(categorizedForecast[iter.index].second) > i and categorizedForecast[iter.index].second[i] != '없음'}"
                                        th:text="${categorizedForecast[iter.index].second[i]}"
                                        class="grade-cell moderate"></td>
                                    <td th:if="${#lists.size(categorizedForecast[iter.index].third) > i and categorizedForecast[iter.index].third[i] != '없음'}"
                                        th:text="${categorizedForecast[iter.index].third[i]}"
                                        class="grade-cell bad"></td>
                                </tr>
                            </table>
                        </div>
                        <div th:if="${forecast?.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                            <h5 class="image-title">예보 이미지</h5>
                            <div class="forecast-images">
                                <img th:each="url : ${forecast.imageUrls}" th:src="${url}" alt="예보 이미지" onclick="openPopup(this.src)" />
                            </div>
                        </div>
                        <div th:unless="${forecast?.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                            <h5 class="image-title">이미지 없음</h5>
                        </div>
                    </div>
                </div>
                <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn next" onclick="moveSlide(1)" aria-label="다음 슬라이드">❯</button>
            </div>
            <div th:unless="${dustForecast != null}">
                <p>미세먼지 예보 데이터를 불러올 수 없습니다. (날짜 형식이 잘못되었거나 API 요청이 실패했습니다.)</p>
            </div>
        </section>
    </div>
</div>

<!-- 실시간 미세먼지 팝업 -->
<div id="realTimeDustPopup" class="popup" role="dialog" aria-label="실시간 미세먼지 팝업">
    <div class="popup-content">
        <button class="close-btn" onclick="closeRealTimeDustPopup()" aria-label="팝업 닫기">X</button>
        <section class="real-time-dust-section" aria-label="실시간 미세먼지">
            <h3>실시간 미세먼지</h3>
            <div th:if="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
                <table class="real-time-dust-table">
                    <thead>
                    <tr>
                        <th>시도</th>
                        <th>측정소</th>
                        <th>측정 시간</th>
                        <th>미세먼지(PM10)</th>
                        <th>미세먼지 등급</th>
                        <th>초미세먼지(PM2.5)</th>
                        <th>초미세먼지 등급</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="dust : ${realTimeDust}">
                        <td th:text="${dust?.sidoName ?: '정보 없음'}"></td>
                        <td th:text="${dust?.stationName ?: '정보 없음'}"></td>
                        <td th:text="${dust?.dataTime ?: '정보 없음'}"></td>
                        <td>
                            <span th:if="${dust?.pm10Value != 'N/A'}" th:text="${dust.pm10Value + ' μg/m³'}"></span>
                            <span th:unless="${dust?.pm10Value != 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                        </td>
                        <td class="grade-cell" th:switch="${dust?.pm10Grade}">
                            <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                            <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                            <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                            <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                            <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                        </td>
                        <td>
                            <span th:if="${dust?.pm25Value != 'N/A'}" th:text="${dust.pm25Value + ' μg/m³'}"></span>
                            <span th:unless="${dust?.pm25Value != 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                        </td>
                        <td class="grade-cell" th:switch="${dust?.pm25Grade}">
                            <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                            <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                            <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                            <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                            <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:unless="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
                <p th:text="${errorMessage ?: '실시간 미세먼지 데이터를 불러올 수 없습니다.'}" style="color: red;"></p>
            </div>
        </section>
    </div>
</div>

<script>
    let currentSlide = 0;

    function updateSlidePosition() {
        const slider = document.getElementById('dustSlider');
        if (!slider) return;
        const items = slider.querySelectorAll('.dust-forecast-item');
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
        const prevBtn = document.querySelector('.slider-btn.prev');
        const nextBtn = document.querySelector('.slider-btn.next');
        if (prevBtn) prevBtn.disabled = currentSlide === 0;
        if (nextBtn) nextBtn.disabled = currentSlide === items.length - 1;
    }

    function moveSlide(direction) {
        const items = document.querySelectorAll('.dust-forecast-item');
        currentSlide = Math.max(0, Math.min(currentSlide + direction, items.length - 1));
        updateSlidePosition();
    }

    function openDustForecastPopup() {
        const popup = document.getElementById('dustForecastPopup');
        popup.style.display = 'flex';
        currentSlide = 0;
        updateSlidePosition();
    }

    function closeDustForecastPopup() {
        document.getElementById('dustForecastPopup').style.display = 'none';
    }

    function openRealTimeDustPopup() {
        document.getElementById('realTimeDustPopup').style.display = 'flex';
    }

    function closeRealTimeDustPopup() {
        document.getElementById('realTimeDustPopup').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const overallTexts = document.querySelectorAll('.overall-text');
        overallTexts.forEach(element => element.textContent = removeParentheses(element.textContent));
        const causeTexts = document.querySelectorAll('.cause-text');
        causeTexts.forEach(element => element.textContent = removeParentheses(element.textContent));

        const locationTitle = document.getElementById('locationTitle');
        if (!locationTitle.textContent.trim()) locationTitle.textContent = '청진동 (종로구)';

        const sidoSelect = document.getElementById('sido');
        const selectedSido = /*[[${selectedSido}]]*/ '';
        if (selectedSido && selectedSido !== '') {
            sidoSelect.value = selectedSido;
            updateSggs().then(() => {
                const sggSelect = document.getElementById('sgg');
                const selectedSgg = /*[[${selectedSgg}]]*/ '';
                if (selectedSgg && selectedSgg !== '') {
                    sggSelect.value = selectedSgg;
                    updateUmds().then(() => {
                        const umdSelect = document.getElementById('umd');
                        const selectedUmd = /*[[${selectedUmd}]]*/ '';
                        if (selectedUmd && selectedUmd !== '') umdSelect.value = selectedUmd;
                    });
                }
            });
        }
    });

    function removeParentheses(text) {
        return text.replace(/\([^()]*\)/g, '').replace(/\[.*?\]/g, '').replace(/\./g, '').trim();
    }

    function openPopup(imageUrl) {
        closeDustForecastPopup();
        closeRealTimeDustPopup();
        closeLocationPopup();
        const popup = document.getElementById('imagePopup');
        document.getElementById('popupImage').src = imageUrl;
        popup.style.display = 'flex';
    }

    function closePopup() {
        document.getElementById('imagePopup').style.display = 'none';
    }

    function openLocationPopup() {
        document.getElementById('locationPopup').style.display = 'flex';
    }

    function closeLocationPopup() {
        document.getElementById('locationPopup').style.display = 'none';
    }

    async function updateSggs() {
        const sido = document.getElementById('sido').value;
        const sggSelect = document.getElementById('sgg');
        const umdSelect = document.getElementById('umd');

        sggSelect.innerHTML = '<option value="">선택하세요</option>';
        umdSelect.innerHTML = '<option value="">먼저 시/군/구를 선택하세요</option>';

        if (!sido) return;

        try {
            const response = await fetch(`/api/regions/sggs?sido=${encodeURIComponent(sido)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const sggs = await response.json();
            if (sggs.length === 0) {
                sggSelect.innerHTML = '<option value="">시/군/구 데이터 없음</option>';
            } else {
                sggs.forEach(sgg => {
                    const option = document.createElement('option');
                    option.value = sgg;
                    option.textContent = sgg;
                    sggSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('시군구 데이터 가져오기 실패:', error);
            sggSelect.innerHTML = '<option value="">시/군/구 데이터를 불러올 수 없습니다</option>';
        }
    }

    async function updateUmds() {
        const sido = document.getElementById('sido').value;
        const sgg = document.getElementById('sgg').value;
        const umdSelect = document.getElementById('umd');

        umdSelect.innerHTML = '<option value="">선택하세요</option>';

        if (!sido || !sgg) return;

        try {
            const response = await fetch(`/api/regions/umds?sido=${encodeURIComponent(sido)}&sgg=${encodeURIComponent(sgg)}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const umds = await response.json();
            if (umds.length === 0) {
                umdSelect.innerHTML = '<option value="">읍/면/동 데이터 없음</option>';
            } else {
                umds.forEach(umd => {
                    const option = document.createElement('option');
                    option.value = umd;
                    option.textContent = umd;
                    umdSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('읍면동 데이터 가져오기 실패:', error);
            umdSelect.innerHTML = '<option value="">읍/면/동 데이터를 불러올 수 없습니다</option>';
        }
    }

    function confirmSelection() {
        const sido = document.getElementById('sido').value;
        const sgg = document.getElementById('sgg').value;
        const umd = document.getElementById('umd').value;

        if (!sido || !sgg || !umd) {
            alert('모든 항목을 선택해 주세요.');
            return;
        }

        document.getElementById('locationTitle').textContent = `${umd} (${sgg})`;
        closeLocationPopup();

        fetch(`/weather?location=${encodeURIComponent(`${sido} ${sgg} ${umd}`)}`)
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('날씨 데이터 업데이트하는 데 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('날씨 데이터 업데이트 실패:', error);
                alert('날씨 데이터를 업데이트하는 데 실패했습니다.');
            });
    }

    // 차트 관련 JavaScript
    async function fetchChartData() {
        try {
            const response = await fetch('/api/chart/temperature');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('차트 데이터 가져오기 실패:', error);
            return {
                startDate: '2025052900',
                temperatures: [18.0, 17.0, 18.0, 18.0, 18.0, 18.0, 18.0, 20.0, 21.0, 22.0]
            };
        }
    }

    function createChart(startDate, temperatures) {
        const year = parseInt(startDate.substring(0, 4));
        const month = parseInt(startDate.substring(4, 6)) - 1;
        const day = parseInt(startDate.substring(6, 8));
        const hour = parseInt(startDate.substring(8, 10));
        const startTime = new Date(year, month, day, hour);
        const labels = [];
        for (let i = 0; i < temperatures.length; i++) {
            const time = new Date(startTime.getTime() + i * 60 * 60 * 1000);
            const label = `${time.getMonth() + 1}/${time.getDate()} ${time.getHours()}:00`;
            labels.push(label);
        }
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Apparent Temperature (°C)',
                    data: temperatures,
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (KST)',
                            font: { size: 14 }
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            autoSkip: true
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (°C)',
                            font: { size: 14 }
                        },
                        beginAtZero: false,
                        suggestedMin: 14,
                        suggestedMax: 30
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Summer Apparent Temperature Forecast',
                        font: { size: 18 }
                    }
                }
            }
        });
    }

    let chart = null;

    async function toggleChart(button) {
        const chartContainer = document.querySelector('.chart-container');
        if (!chartContainer) return;

        button.classList.toggle('clicked');
        if (button.classList.contains('clicked')) {
            chartContainer.style.display = 'block';
            if (!chart) {
                try {
                    const chartData = await fetchChartData();
                    chart = createChart(chartData.startDate, chartData.temperatures);
                } catch (error) {
                    console.error('차트 생성 실패:', error);
                    alert('차트를 생성하는 데 실패했습니다.');
                    chartContainer.style.display = 'none';
                    button.classList.remove('clicked');
                }
            }
        } else {
            chartContainer.style.display = 'none';
        }
    }
</script>
<script type="text/javascript" th:src="@{/static/global/global.js}"></script>
</body>
</html>