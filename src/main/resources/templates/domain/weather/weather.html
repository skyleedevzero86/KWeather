<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 예보</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/static/global/global.css}" />
    <link rel="stylesheet" th:href="@{/static/global/style.css}" />
    <style>
        .precipitation-forecast-section table {
            width: 100%;
            border-collapse: separate; /* 테이블 간격을 조정하기 위해 separate 사용 */
            border-spacing: 2px; /* 셀 간의 간격 조정 */
            margin-top: 10px;
        }
        .precipitation-forecast-section th, .precipitation-forecast-section td {
            border: 1px solid #ddd;
            padding: 12px; /* 패딩을 늘려서 셀 내부 간격 조정 */
            text-align: center;
        }
        .precipitation-forecast-section th {
            background-color: #f2f2f2;
        }
        .na-message {
            color: red;
        }
    </style>
</head>
<body>
<div class="weather-container">
    <div class="weather-header">
        <p class="datetime">
            <span class="date" th:text="${weather.date}"></span>
            <span class="time" th:text="${weather.time}"></span>
            <span class="timeofday" th:text="'오후'"></span>
        </p>
        <div class="location-row">
            <h1 id="locationTitle" th:text="${weather.location}"></h1>
            <button class="location-btn" onclick="openLocationPopup()">변경</button>
        </div>
        <div class="weather-main">
            <div class="current-temp">
                <span class="moon-icon" th:classappend="${weather.hourlyForecast[0].icon}"></span>
                <span th:text="${weather.currentTemperature}" class="temp-value"></span>
                <div class="temp-range" th:text="${weather.highLowTemperature}"></div>
            </div>
            <div class="weather-info">
                <div class="weather-condition" th:text="${weather.weatherCondition}"></div>
                <div class="humidity" th:text="'습도 ' + ${weather.hourlyForecast[0].humidity}"></div>
                <div class="pm-value" th:text="'미세먼지 ' + ${weather.airQuality.value}"></div>
            </div>
        </div>
    </div>
    <div class="weather-details">
        <div class="air-quality">
            <h3 th:text="${weather.airQuality.title}"></h3>
            <span class="icon" th:classappend="${weather.airQuality.icon}"></span>
            <p class="status" th:text="${weather.airQuality.status}"></p>
            <p th:text="${weather.airQuality.value + ' ' + weather.airQuality.measurement}"></p>
        </div>
        <div class="uv-index">
            <h3 th:text="${weather.uvIndex.title}"></h3>
            <span class="icon" th:classappend="${weather.uvIndex.icon}"></span>
            <p class="status" th:text="${weather.uvIndex.status}"></p>
            <p th:text="${weather.uvIndex.value + ' ' + weather.uvIndex.measurement}"></p>
        </div>
    </div>
    <div class="forecast-section">
        <h3>시간대별 날씨</h3>
        <div class="forecast-row">
            <div th:each="forecast : ${weather.hourlyForecast}" class="forecast-item">
                <span class="time" th:text="${forecast.time}"></span>
                <span class="icon" th:classappend="${forecast.icon}"></span>
                <span class="temp" th:text="${forecast.temperature}"></span>
                <span class="humid" th:text="${forecast.humidity}"></span>
            </div>
        </div>
    </div>
    <div class="dust-forecast-section">
        <h3>미세먼지 예보</h3>
        <div th:if="${dustForecast != null}">
            <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn prev" onclick="moveSlide(-1)">❮</button>
            <div class="dust-slider" id="dustSlider">
                <div th:each="forecast, iter : ${dustForecast}" class="dust-forecast-item">
                    <h4 th:text="${forecast.date} + ' (' + ${forecast.type} + ')'"></h4>
                    <p th:text="'시간: ' + ${forecast.dataTime}"></p>
                    <p class="overall-text" th:text="${forecast.overall}" th:unless="${forecast.overall == 'N/A'}"></p>
                    <p class="cause-text" th:text="${forecast.cause}" th:unless="${forecast.cause == 'N/A'}"></p>
                    <div class="grade-section">
                        <table class="grade-table">
                            <tr>
                                <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].first) and not (categorizedForecast[iter.index].first.size() == 1 and categorizedForecast[iter.index].first[0] == 'N/A')}"
                                    class="grade-title good">좋음</th>
                                <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].second) and not (categorizedForecast[iter.index].second.size() == 1 and categorizedForecast[iter.index].second[0] == 'N/A')}"
                                    class="grade-title moderate">보통</th>
                                <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].third) and not (categorizedForecast[iter.index].third.size() == 1 and categorizedForecast[iter.index].third[0] == 'N/A')}"
                                    class="grade-title bad">나쁨</th>
                            </tr>
                            <th:block th:with="forecastData=${categorizedForecast[iter.index] != null ? categorizedForecast[iter.index] : null},
                                             maxRows=${forecastData != null ? (#lists.size(forecastData.first) > #lists.size(forecastData.second) ?
                                              (#lists.size(forecastData.first) > #lists.size(forecastData.third) ? #lists.size(forecastData.first) : #lists.size(forecastData.third)) :
                                              (#lists.size(forecastData.second) > #lists.size(forecastData.third) ? #lists.size(forecastData.second) : #lists.size(forecastData.third))) : 0}">
                                <tr th:each="i : ${#numbers.sequence(0, maxRows > 0 ? maxRows - 1 : 0)}">
                                    <td th:if="${categorizedForecast[iter.index] != null and not #lists.isEmpty(categorizedForecast[iter.index].first) and not (categorizedForecast[iter.index].first.size() == 1 and categorizedForecast[iter.index].first[0] == 'N/A')}"
                                        th:text="${#lists.size(categorizedForecast[iter.index].first) > i ? categorizedForecast[iter.index].first[i] : ''}"
                                        th:unless="${#lists.size(categorizedForecast[iter.index].first) > i and categorizedForecast[iter.index].first[i] == 'N/A'}"
                                        class="grade-cell good"></td>
                                    <td th:if="${categorizedForecast[iter.index] != null and not #lists.isEmpty(categorizedForecast[iter.index].second) and not (categorizedForecast[iter.index].second.size() == 1 and categorizedForecast[iter.index].second[0] == 'N/A')}"
                                        th:text="${#lists.size(categorizedForecast[iter.index].second) > i ? categorizedForecast[iter.index].second[i] : ''}"
                                        th:unless="${#lists.size(categorizedForecast[iter.index].second) > i and categorizedForecast[iter.index].second[i] == 'N/A'}"
                                        class="grade-cell moderate"></td>
                                    <td th:if="${categorizedForecast[iter.index] != null and not #lists.isEmpty(categorizedForecast[iter.index].third) and not (categorizedForecast[iter.index].third.size() == 1 and categorizedForecast[iter.index].third[0] == 'N/A')}"
                                        th:text="${#lists.size(categorizedForecast[iter.index].third) > i ? categorizedForecast[iter.index].third[i] : ''}"
                                        th:unless="${#lists.size(categorizedForecast[iter.index].third) > i and categorizedForecast[iter.index].third[i] == 'N/A'}"
                                        class="grade-cell bad"></td>
                                </tr>
                            </th:block>
                        </table>
                    </div>
                    <div th:if="${forecast.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                        <h5 class="image-title">예보 이미지</h5>
                        <div class="forecast-images">
                            <img th:each="url : ${forecast.imageUrls}" th:src="${url}" alt="예보 이미지" onclick="openPopup(this.src)" />
                        </div>
                    </div>
                    <div th:if="${forecast.imageUrls == null or #lists.isEmpty(forecast.imageUrls)}">
                        <h5 class="image-title">이미지 없음</h5>
                    </div>
                </div>
            </div>
            <button th:if="${#lists.size(dustForecast) > 1}" class="slider-btn next" onclick="moveSlide(1)">❯</button>
        </div>
        <div th:if="${dustForecast == null}">
            <p>미세먼지 예보 데이터를 불러올 수 없습니다. (날짜 형식이 잘못되었거나 API 요청이 실패했습니다.)</p>
        </div>
    </div>
    <div class="real-time-dust-section">
        <h3>실시간 미세먼지</h3>
        <div th:if="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
            <table class="real-time-dust-table">
                <tr>
                    <th>시도</th>
                    <th>측정소</th>
                    <th>측정 시간</th>
                    <th>미세먼지(PM10)</th>
                    <th>미세먼지 등급</th>
                    <th>초미세먼지(PM2.5)</th>
                    <th>초미세먼지 등급</th>
                </tr>
                <tr th:each="dust : ${realTimeDust}">
                    <td th:text="${dust.sidoName}"></td>
                    <td th:text="${dust.stationName}"></td>
                    <td th:text="${dust.dataTime}"></td>
                    <td>
                        <span th:if="${dust.pm10Value != 'N/A'}" th:text="${dust.pm10Value} + ' μg/m³'"></span>
                        <span th:if="${dust.pm10Value == 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <td class="grade-cell" th:switch="${dust.pm10Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                    <td>
                        <span th:if="${dust.pm25Value != 'N/A'}" th:text="${dust.pm25Value} + ' μg/m³'"></span>
                        <span th:if="${dust.pm25Value == 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <td class="grade-cell" th:switch="${dust.pm25Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${realTimeDust == null or #lists.isEmpty(realTimeDust)}">
            <p th:text="${errorMessage != null ? errorMessage : '실시간 미세먼지 데이터를 불러올 수 없습니다.'}" style="color: red;"></p>
        </div>
    </div>
    <div class="uv-index-forecast-section">
        <h3>자외선 지수 예보</h3>
        <div th:if="${uvIndexData != null and not #lists.isEmpty(uvIndexData)}">
            <table class="forecast-table">
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${uvHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                <tr th:each="uv : ${uvIndexData}">
                    <td th:text="${uv.date}"></td>
                    <td th:each="hour : ${uvHoursSequence}">
                        <span th:switch="${uv.values['h' + hour]}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${uv.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${uvIndexData == null or #lists.isEmpty(uvIndexData)}">
            <p style="color: red;">자외선 지수 데이터를 불러올 수 없습니다.</p>
        </div>
    </div>
    <div class="senta-index-forecast-section">
        <h3>여름철 체감온도 예보 (5월~9월)</h3>
        <div th:if="${senTaIndexData != null and not #lists.isEmpty(senTaIndexData)}">
            <table class="forecast-table">
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${sentaHoursSequence}" th:text="'+' + ${hour - 1} + '시간'"></th>
                </tr>
                <tr th:each="senta : ${senTaIndexData}">
                    <td th:text="${senta.date}"></td>
                    <td th:each="hour : ${sentaHoursSequence}">
                        <span th:switch="${senta.values['h' + hour]}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${senta.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${senTaIndexData == null or #lists.isEmpty(senTaIndexData)}">
            <p style="color: red;">체감온도 데이터를 불러올 수 없습니다. (5월~9월에만 제공됩니다.)</p>
        </div>
    </div>
    <div class="air-stagnation-index-forecast-section">
        <h3>대기정체지수 예보</h3>
        <div th:if="${airStagnationIndexData != null and not #lists.isEmpty(airStagnationIndexData)}">
            <table class="forecast-table">
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${asiHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                <tr th:each="asi : ${airStagnationIndexData}">
                    <td th:text="${asi.date}"></td>
                    <td th:each="hour : ${asiHoursSequence}">
                        <span th:switch="${asi.values['h' + hour]}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${asi.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${airStagnationIndexData == null or #lists.isEmpty(airStagnationIndexData)}">
            <p style="color: red;">대기정체지수 데이터를 불러올 수 없습니다.</p>
        </div>
    </div>
    <div class="precipitation-forecast-section">
        <h3>강수량 예보</h3>
        <div th:if="${precipitationData != null and not #lists.isEmpty(precipitationData)}">
            <table class="forecast-table">
                <tr>
                    <th>날짜</th>
                    <th th:each="hour : ${precipHoursSequence}" th:text="'+' + ${hour} + '시간'"></th>
                </tr>
                <tr th:each="precip : ${precipitationData}">
                    <td th:text="${precip.date}"></td>
                    <td th:each="hour : ${precipHoursSequence}">
                        <span th:switch="${precip.values['h' + hour]}">
                            <span th:case="null" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="''" class="na-message" th:text="'데이터 없음'"></span>
                            <span th:case="*" th:text="${precip.values['h' + hour]}"></span>
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${precipitationData == null or #lists.isEmpty(precipitationData)}">
            <p style="color: red;">강수량 데이터를 불러올 수 없습니다.</p>
        </div>
    </div>
</div>

<div id="imagePopup" class="popup">
    <div class="popup-content">
        <button class="close-btn" onclick="closePopup()">X</button>
        <img id="popupImage" src="" alt="확대된 이미지">
    </div>
</div>

<div id="locationPopup" class="popup">
    <div id="locationPopupContent">
        <button class="close-btn" onclick="closeLocationPopup()">X</button>
        <div class="select-group">
            <label for="country">국가:</label>
            <select id="country" onchange="updateCities()">
                <option value="">선택하세요</option>
                <option value="korea">대한민국</option>
            </select>
        </div>
        <div class="select-group">
            <label for="city">도시:</label>
            <select id="city" onchange="updateDistricts()">
                <option value="">먼저 국가를 선택하세요</option>
            </select>
        </div>
        <div class="select-group">
            <label for="district">구/군:</label>
            <select id="district">
                <option value="">먼저 도시를 선택하세요</option>
            </select>
        </div>
        <button id="confirmBtn" onclick="confirmSelection()">확인</button>
    </div>
</div>

<script>
    let currentSlide = 0;
    let totalSlides = document.querySelectorAll('.dust-forecast-item').length;

    function updateSlidePosition() {
        const slider = document.getElementById('dustSlider');
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;

        const prevBtn = document.querySelector('.slider-btn.prev');
        const nextBtn = document.querySelector('.slider-btn.next');
        if (prevBtn) prevBtn.disabled = currentSlide === 0;
        if (nextBtn) nextBtn.disabled = currentSlide === totalSlides - 1;
    }

    function moveSlide(direction) {
        currentSlide += direction;
        if (currentSlide < 0) currentSlide = 0;
        if (currentSlide >= totalSlides) currentSlide = totalSlides - 1;
        updateSlidePosition();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.overall-text').forEach(element => {
            element.textContent = removeParentheses(element.textContent);
        });
        document.querySelectorAll('.cause-text').forEach(element => {
            element.textContent = removeParentheses(element.textContent);
        });

        if (totalSlides <= 1) {
            const prevBtn = document.querySelector('.slider-btn.prev');
            const nextBtn = document.querySelector('.slider-btn.next');
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
        } else {
            updateSlidePosition();
        }
    });

    function removeParentheses(text) {
        return text.replace(/\([^()]*\)/g, '').replace(/\[.*?\]/g, '').replace(/\./g, '').trim();
    }

    function openPopup(imageUrl) {
        const popup = document.getElementById('imagePopup');
        const popupImage = document.getElementById('popupImage');
        popupImage.src = imageUrl;
        popup.style.display = 'flex';
    }

    function closePopup() {
        const popup = document.getElementById('imagePopup');
        popup.style.display = 'none';
    }

    function openLocationPopup() {
        const popup = document.getElementById('locationPopup');
        popup.style.display = 'flex';
    }

    function closeLocationPopup() {
        const popup = document.getElementById('locationPopup');
        popup.style.display = 'none';
    }

    function updateCities() {
        const country = document.getElementById('country').value;
        const citySelect = document.getElementById('city');
        citySelect.innerHTML = '<option value="">선택하세요</option>';
        if (country === 'korea') {
            ['서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종', '경기', '강원', '충북', '충남', '전북', '전남', '경북', '경남', '제주'].forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
        document.getElementById('district').innerHTML = '<option value="">먼저 도시를 선택하세요</option>';
    }

    function updateDistricts() {
        const city = document.getElementById('city').value;
        const districtSelect = document.getElementById('district');
        districtSelect.innerHTML = '<option value="">선택하세요</option>';
        const districts = {
            '서울': ['종로구', '중구', '용산구', '성동구', '광진구', '동대문구', '중랑구', '성북구', '강북구', '도봉구', '노원구', '은평구', '서대문구', '마포구', '양천구', '강서구', '구로구', '금천구', '영등포구', '동작구', '관악구', '서초구', '강남구', '송파구', '강동구'],
            '부산': ['중구', '서구', '동구', '영도구', '부산진구', '동래구', '남구', '북구', '해운대구', '사하구', '금정구', '강서구', '연제구', '수영구', '사상구', '기장군'],
            '대구': ['중구', '동구', '서구', '남구', '북구', '수성구', '달서구', '달성군'],
            '인천': ['중구', '동구', '미추홀구', '연수구', '남동구', '부평구', '계양구', '서구', '강화군', '옹진군'],
            '광주': ['동구', '서구', '남구', '북구', '광산구'],
            '대전': ['동구', '중구', '서구', '유성구', '대덕구'],
            '울산': ['중구', '남구', '동구', '북구', '울주군'],
            '세종': ['세종시'],
            '경기': ['수원시', '성남시', '고양시', '용인시', '부천시', '안산시', '안양시', '남양주시', '화성시', '평택시', '의정부시', '시흥시', '파주시', '김포시', '광명시', '광주시', '군포시', '하남시', '오산시', '구리시', '안성시', '이천시', '양평군', '여주시', '연천군', '가평군', '양주시', '포천시', '동두천시', '의왕시', '과천시'],
            '강원': ['춘천시', '원주시', '강릉시', '동해시', '태백시', '속초시', '삼척시', '홍천군', '횡성군', '영월군', '평창군', '정선군', '철원군', '화천군', '양구군', '인제군', '고성군', '양양군'],
            '충북': ['청주시', '충주시', '제천시', '보은군', '옥천군', '영동군', '진천군', '괴산군', '음성군', '단양군', '증평군'],
            '충남': ['천안시', '공주시', '보령시', '아산시', '서산시', '논산시', '계룡시', '당진시', '금산군', '부여군', '서천군', '청양군', '홍성군', '예산군', '태안군'],
            '전북': ['전주시', '익산시', '군산시', '정읍시', '남원시', '김제시', '완주군', '진안군', '무주군', '장수군', '임실군', '순창군', '고창군', '부안군'],
            '전남': ['목포시', '여수시', '순천시', '나주시', '광양시', '담양군', '곡성군', '구례군', '고흥군', '보성군', '화순군', '장흥군', '강진군', '해남군', '영암군', '무안군', '함평군', '영광군', '장성군', '완도군', '진도군', '신안군'],
            '경북': ['포항시', '경주시', '김천시', '안동시', '구미시', '영주시', '영천시', '상주시', '문경시', '경산시', '의성군', '청송군', '영양군', '영덕군', '청도군', '고령군', '성주군', '칠곡군', '예천군', '봉화군', '울진군', '울릉군'],
            '경남': ['창원시', '진주시', '통영시', '사천시', '김해시', '밀양시', '거제시', '양산시', '의령군', '함안군', '창녕군', '남해군', '하동군', '산청군', '함양군', '거창군', '합천군'],
            '제주': ['제주시', '서귀포시']
        };
        if (districts[city]) {
            districts[city].forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
    }

    function confirmSelection() {
        const country = document.getElementById('country').value;
        const city = document.getElementById('city').value;
        const district = document.getElementById('district').value;
        if (country && city && district) {
            document.getElementById('locationTitle').textContent = `${district} (${city})`;
            closeLocationPopup();
        } else {
            alert('모든 항목을 선택해 주세요.');
        }
    }
</script>
</body>
</html>