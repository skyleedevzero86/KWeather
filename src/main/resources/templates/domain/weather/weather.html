<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 예보</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/static/global/global.css}" />
    <link rel="stylesheet" th:href="@{/static/global/style.css}" />
    <style>
        .na-message {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="weather-container">
    <div class="weather-header">
        <p class="datetime">
            <span class="date" th:text="${weather.date}"></span>
            <span class="time" th:text="${weather.time}"></span>
            <span class="timeofday" th:text="${timeOfDay}"></span>
        </p>
        <h1 th:text="${weather.location}"></h1>
        <div class="weather-main">
            <div class="current-temp">
                <span class="moon-icon" th:classappend="${weather.hourlyForecast[0].icon}"></span>
                <span th:text="${weather.currentTemperature}" class="temp-value"></span>
                <div class="temp-range" th:text="${weather.highLowTemperature}"></div>
            </div>
            <div class="weather-info">
                <div class="weather-condition" th:text="${weather.weatherCondition}"></div>
                <div class="humidity" th:text="'습도 ' + ${weather.hourlyForecast[0].humidity}"></div>
                <div class="pm-value" th:text="'미세먼지 ' + ${weather.airQuality.value}"></div>
            </div>
        </div>
    </div>
    <div class="weather-details">
        <div class="air-quality">
            <h3 th:text="${weather.airQuality.title}"></h3>
            <span class="icon" th:classappend="${weather.airQuality.icon}"></span>
            <p class="status" th:text="${weather.airQuality.status}"></p>
            <p th:text="${weather.airQuality.value + ' ' + weather.airQuality.measurement}"></p>
        </div>
        <div class="uv-index">
            <h3 th:text="${weather.uvIndex.title}"></h3>
            <span class="icon" th:classappend="${weather.uvIndex.icon}"></span>
            <p class="status" th:text="${weather.uvIndex.status}"></p>
            <p th:text="${weather.uvIndex.value + ' ' + weather.uvIndex.measurement}"></p>
        </div>
    </div>
    <div class="forecast-section">
        <h3>시간대별 날씨</h3>
        <div class="forecast-row">
            <div th:each="forecast : ${weather.hourlyForecast}" class="forecast-item">
                <span class="time" th:text="${forecast.time}"></span>
                <span class="icon" th:classappend="${forecast.icon}"></span>
                <span class="temp" th:text="${forecast.temperature}"></span>
                <span class="humid" th:text="${forecast.humidity}"></span>
            </div>
        </div>
    </div>
    <div class="dust-forecast-section">
        <h3>미세먼지 예보</h3>
        <div th:if="${dustForecast != null}">
            <div th:each="forecast, iter : ${dustForecast}" class="dust-forecast-item">
                <h4 th:text="${forecast.date} + ' (' + ${forecast.type} + ')'"></h4>
                <p th:text="'시간: ' + ${forecast.dataTime}"></p>
                <p class="overall-text" th:text="${forecast.overall}" th:unless="${forecast.overall == 'N/A'}"></p>
                <p class="cause-text" th:text="${forecast.cause}" th:unless="${forecast.cause == 'N/A'}"></p>
                <div class="grade-section">
                    <table class="grade-table">
                        <!-- 헤더 행 -->
                        <tr>
                            <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].first) and not (categorizedForecast[iter.index].first.size() == 1 and categorizedForecast[iter.index].first[0] == 'N/A')}"
                                class="grade-title good">좋음</th>
                            <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].second) and not (categorizedForecast[iter.index].second.size() == 1 and categorizedForecast[iter.index].second[0] == 'N/A')}"
                                class="grade-title moderate">보통</th>
                            <th th:if="${not #lists.isEmpty(categorizedForecast[iter.index].third) and not (categorizedForecast[iter.index].third.size() == 1 and categorizedForecast[iter.index].third[0] == 'N/A')}"
                                class="grade-title bad">나쁨</th>
                        </tr>
                        <!-- 최대 행 수 계산 전에 null 체크 -->
                        <th:block th:with="forecastData=${categorizedForecast[iter.index] != null ? categorizedForecast[iter.index] : null},
                                         maxRows=${forecastData != null ? (#lists.size(forecastData.first) > #lists.size(forecastData.second) ?
                                          (#lists.size(forecastData.first) > #lists.size(forecastData.third) ? #lists.size(forecastData.first) : #lists.size(forecastData.third)) :
                                          (#lists.size(forecastData.second) > #lists.size(forecastData.third) ? #lists.size(forecastData.second) : #lists.size(forecastData.third))) : 0}">
                            <!-- 데이터 행 -->
                            <tr th:each="i : ${#numbers.sequence(0, maxRows > 0 ? maxRows - 1 : 0)}">
                                <td th:if="${not #lists.isEmpty(categorizedForecast[iter.index].first) and not (categorizedForecast[iter.index].first.size() == 1 and categorizedForecast[iter.index].first[0] == 'N/A')}"
                                    th:text="${#lists.size(categorizedForecast[iter.index].first) > i ? categorizedForecast[iter.index].first[i] : ''}"
                                    th:unless="${#lists.size(categorizedForecast[iter.index].first) > i and categorizedForecast[iter.index].first[i] == 'N/A'}"
                                    class="grade-cell good"></td>
                                <td th:if="${not #lists.isEmpty(categorizedForecast[iter.index].second) and not (categorizedForecast[iter.index].second.size() == 1 and categorizedForecast[iter.index].second[0] == 'N/A')}"
                                    th:text="${#lists.size(categorizedForecast[iter.index].second) > i ? categorizedForecast[iter.index].second[i] : ''}"
                                    th:unless="${#lists.size(categorizedForecast[iter.index].second) > i and categorizedForecast[iter.index].second[i] == 'N/A'}"
                                    class="grade-cell moderate"></td>
                                <td th:if="${not #lists.isEmpty(categorizedForecast[iter.index].third) and not (categorizedForecast[iter.index].third.size() == 1 and categorizedForecast[iter.index].third[0] == 'N/A')}"
                                    th:text="${#lists.size(categorizedForecast[iter.index].third) > i ? categorizedForecast[iter.index].third[i] : ''}"
                                    th:unless="${#lists.size(categorizedForecast[iter.index].third) > i and categorizedForecast[iter.index].third[i] == 'N/A'}"
                                    class="grade-cell bad"></td>
                            </tr>
                        </th:block>
                    </table>
                </div>
                <div th:if="${forecast.imageUrls != null and not #lists.isEmpty(forecast.imageUrls)}">
                    <h5 class="image-title">예보 이미지</h5>
                    <div class="forecast-images">
                        <img th:each="url : ${forecast.imageUrls}" th:src="${url}" alt="예보 이미지" style="max-width: 100px; margin: 5px;" onclick="openPopup(this.src)" />
                    </div>
                </div>
                <div th:if="${forecast.imageUrls == null or #lists.isEmpty(forecast.imageUrls)}">
                    <h5 class="image-title">이미지 없음</h5>
                </div>
            </div>
        </div>
        <div th:if="${dustForecast == null}">
            <p>미세먼지 예보 데이터를 불러올 수 없습니다. (날짜 형식이 잘못되었거나 API 요청이 실패했습니다.)</p>
        </div>
    </div>
    <!-- 실시간 미세먼지 섹션 -->
    <div class="real-time-dust-section">
        <h3>실시간 미세먼지</h3>
        <div th:if="${realTimeDust != null and not #lists.isEmpty(realTimeDust)}">
            <table class="real-time-dust-table">
                <tr>
                    <th>시도</th>
                    <th>측정소</th>
                    <th>측정 시간</th>
                    <th>미세먼지(PM10)</th>
                    <th>미세먼지 등급</th>
                    <th>초미세먼지(PM2.5)</th>
                    <th>초미세먼지 등급</th>
                </tr>
                <tr th:each="dust : ${realTimeDust}">
                    <td th:text="${dust.sidoName}"></td>
                    <td th:text="${dust.stationName}"></td>
                    <td th:text="${dust.dataTime}"></td>
                    <!-- 미세먼지(PM10) 값 표시 -->
                    <td>
                        <span th:if="${dust.pm10Value != 'N/A'}" th:text="${dust.pm10Value} + ' μg/m³'"></span>
                        <span th:if="${dust.pm10Value == 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <!-- 미세먼지 등급 표시 -->
                    <td class="grade-cell" th:switch="${dust.pm10Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                    <!-- 초미세먼지(PM2.5) 값 표시 -->
                    <td>
                        <span th:if="${dust.pm25Value != 'N/A'}" th:text="${dust.pm25Value} + ' μg/m³'"></span>
                        <span th:if="${dust.pm25Value == 'N/A'}" class="na-message" th:text="'측정 중'"></span>
                    </td>
                    <!-- 초미세먼지 등급 표시 -->
                    <td class="grade-cell" th:switch="${dust.pm25Grade}">
                        <span th:case="'N/A'" class="na-message" th:text="'측정 중'"></span>
                        <span th:case="'좋음'" class="grade-good" th:text="'좋음'"></span>
                        <span th:case="'보통'" class="grade-moderate" th:text="'보통'"></span>
                        <span th:case="'나쁨'" class="grade-bad" th:text="'나쁨'"></span>
                        <span th:case="'매우나쁨'" class="grade-very-bad" th:text="'매우나쁨'"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div th:if="${realTimeDust == null or #lists.isEmpty(realTimeDust)}">
            <p th:text="${errorMessage != null ? errorMessage : '실시간 미세먼지 데이터를 불러올 수 없습니다.'}" style="color: red;"></p>
        </div>
    </div>
</div>

<!-- 팝업 HTML -->
<div id="imagePopup" class="popup">
    <div class="popup-content">
        <button class="close-btn" onclick="closePopup()">X</button>
        <img id="popupImage" src="" alt="확대된 이미지">
    </div>
</div>

<script>
    // 괄호와 괄호 안 내용을 제거하는 함수
    function removeParentheses(text) {
        return text.replace(/\([^()]*\)/g, '').replace(/\[.*?\]/g, '').replace(/\./g, '').trim();
    }

    // DOM이 로드된 후 실행
    document.addEventListener('DOMContentLoaded', () => {
        // 요약과 원인에서 괄호 제거
        document.querySelectorAll('.overall-text').forEach(element => {
            element.textContent = removeParentheses(element.textContent);
        });
        document.querySelectorAll('.cause-text').forEach(element => {
            element.textContent = removeParentheses(element.textContent);
        });
    });

    function openPopup(imageUrl) {
        const popup = document.getElementById('imagePopup');
        const popupImage = document.getElementById('popupImage');
        popupImage.src = imageUrl;
        popup.style.display = 'flex';
    }

    function closePopup() {
        const popup = document.getElementById('imagePopup');
        popup.style.display = 'none';
    }

    document.getElementById('imagePopup').addEventListener('click', function(event) {
        event.stopPropagation();
    });

    document.querySelector('.popup-content').addEventListener('click', function(event) {
        event.stopPropagation();
    });
</script>
</body>
</html>